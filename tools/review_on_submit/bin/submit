#!/usr/bin/env python3

import argparse
from pathlib import Path
import subprocess
import sys
import os

from registry import registry


def main() -> None:
    parser = argparse.ArgumentParser(description="Submit changes for review")
    parser.add_argument("-f", "--force", action="store_true", help="Force submit without review")
    args = parser.parse_args()

    repo_root = registry.get("ROOT", os.getenv("ROOT"))
    assert repo_root

    patch_path = Path("/root/model.patch")

    subprocess.run(
        f"git add -A && git diff --cached > {patch_path}",
        shell=True,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        cwd=repo_root,
    )

    patch = patch_path.read_text()

    if not args.force and not registry.get("SUBMIT_TRIGGERED_BEFORE"):
        message = registry.get("SUBMIT_REVIEW_MESSAGE", "")
        message = message.replace("{{diff}}", patch)
        message = message.replace("{{problem_statement}}", registry.get("PROBLEM_STATEMENT", ""))
        registry["SUBMIT_TRIGGERED_BEFORE"] = True
        print(message)
        sys.exit(0)

    print("<<SWE_AGENT_SUBMISSION>>")
    print(patch)
    print("<<SWE_AGENT_SUBMISSION>>")

    patch_path.unlink()


if __name__ == "__main__":
    main()
